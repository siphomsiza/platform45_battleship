#!/usr/bin/env node
!function(e){"use strict";var c=require("path"),p=require("fs"),n=p.existsSync||c.existsSync,i=require("formidable"),l=require("node-static"),u=require("imagemagick"),d={tmpDir:__dirname+"/tmp",publicDir:__dirname+"/public",uploadDir:__dirname+"/public/files",uploadUrl:"/files/",maxPostSize:11e9,minFileSize:1,maxFileSize:1e10,acceptFileTypes:/.+/i,inlineFileTypes:/\.(gif|jpe?g|png)$/i,imageTypes:/\.(gif|jpe?g|png)$/i,imageVersions:{thumbnail:{width:80,height:80}},accessControl:{allowOrigin:"*",allowMethods:"OPTIONS, HEAD, GET, POST, PUT, DELETE",allowHeaders:"Content-Type, Content-Range, Content-Disposition"},nodeStatic:{cache:3600}},h=function(e){return unescape(encodeURIComponent(e))},o=new l.Server(d.publicDir,d.nodeStatic),t=/(?:(?: \(([\d]+)\))?(\.[^.]+))?$/,s=function(e,i,t){return" ("+((parseInt(i,10)||0)+1)+")"+(t||"")},m=function(e){this.name=e.name,this.size=e.size,this.type=e.type,this.deleteType="DELETE"},a=function(e,i,t){this.req=e,this.res=i,this.callback=t},r=function(t,n){n.setHeader("Access-Control-Allow-Origin",d.accessControl.allowOrigin),n.setHeader("Access-Control-Allow-Methods",d.accessControl.allowMethods),n.setHeader("Access-Control-Allow-Headers",d.accessControl.allowHeaders);var e=function(){n.setHeader("Pragma","no-cache"),n.setHeader("Cache-Control","no-store, no-cache, must-revalidate"),n.setHeader("Content-Disposition",'inline; filename="files.json"')},i=new a(t,n,function(e,i){i?(n.writeHead(302,{Location:i.replace(/%s/,encodeURIComponent(JSON.stringify(e)))}),n.end()):(n.writeHead(200,{"Content-Type":-1!==t.headers.accept.indexOf("application/json")?"application/json":"text/plain"}),n.end(JSON.stringify(e)))});switch(t.method){case"OPTIONS":n.end();break;case"HEAD":case"GET":"/"===t.url?(e(),"GET"===t.method?i.get():n.end()):o.serve(t,n);break;case"POST":e(),i.post();break;case"DELETE":i.destroy();break;default:n.statusCode=405,n.end()}};o.respond=function(e,i,t,n,o,s,a,r){t["X-Content-Type-Options"]="nosniff",d.inlineFileTypes.test(n[0])||(t["Content-Type"]="application/octet-stream",t["Content-Disposition"]='attachment; filename="'+h(c.basename(n[0]))+'"'),l.Server.prototype.respond.call(this,e,i,t,n,o,s,a,r)},m.prototype.validate=function(){return d.minFileSize&&d.minFileSize>this.size?this.error="File is too small":d.maxFileSize&&d.maxFileSize<this.size?this.error="File is too big":d.acceptFileTypes.test(this.name)||(this.error="Filetype not allowed"),!this.error},m.prototype.safeName=function(){for(this.name=c.basename(this.name).replace(/^\.+/,"");n(d.uploadDir+"/"+this.name);)this.name=this.name.replace(t,s)},m.prototype.initUrls=function(e){if(!this.error){var i=this,t=(d.ssl?"https:":"http:")+"//"+e.headers.host+d.uploadUrl;this.url=this.deleteUrl=t+encodeURIComponent(this.name),Object.keys(d.imageVersions).forEach(function(e){n(d.uploadDir+"/"+e+"/"+i.name)&&(i[e+"Url"]=t+e+"/"+encodeURIComponent(i.name))})}},a.prototype.get=function(){var n=this,o=[];p.readdir(d.uploadDir,function(e,i){i.forEach(function(e){var i,t=p.statSync(d.uploadDir+"/"+e);t.isFile()&&"."!==e[0]&&((i=new m({name:e,size:t.size})).initUrls(n.req),o.push(i))}),n.callback({files:o})})},a.prototype.post=function(){var t,n=this,e=new i.IncomingForm,o=[],s=[],a={},r=1,l=function(){(r-=1)||(s.forEach(function(e){e.initUrls(n.req)}),n.callback({files:s},t))};e.uploadDir=d.tmpDir,e.on("fileBegin",function(e,i){o.push(i.path);var t=new m(i,n.req,!0);t.safeName(),a[c.basename(i.path)]=t,s.push(t)}).on("field",function(e,i){"redirect"===e&&(t=i)}).on("file",function(e,i){var t=a[c.basename(i.path)];t.size=i.size,t.validate()?(p.renameSync(i.path,d.uploadDir+"/"+t.name),d.imageTypes.test(t.name)&&Object.keys(d.imageVersions).forEach(function(e){r+=1;var i=d.imageVersions[e];u.resize({width:i.width,height:i.height,srcPath:d.uploadDir+"/"+t.name,dstPath:d.uploadDir+"/"+e+"/"+t.name},l)})):p.unlink(i.path)}).on("aborted",function(){o.forEach(function(e){p.unlink(e)})}).on("error",function(e){console.log(e)}).on("progress",function(e){e>d.maxPostSize&&n.req.connection.destroy()}).on("end",l).parse(n.req)},a.prototype.destroy=function(){var i,t=this;t.req.url.slice(0,d.uploadUrl.length)!==d.uploadUrl||"."===(i=c.basename(decodeURIComponent(t.req.url)))[0]?t.callback({success:!1}):p.unlink(d.uploadDir+"/"+i,function(e){Object.keys(d.imageVersions).forEach(function(e){p.unlink(d.uploadDir+"/"+e+"/"+i)}),t.callback({success:!e})})},d.ssl?require("https").createServer(d.ssl,r).listen(e):require("http").createServer(r).listen(e)}(8888);