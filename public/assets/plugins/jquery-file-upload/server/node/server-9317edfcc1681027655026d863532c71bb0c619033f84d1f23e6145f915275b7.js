#!/usr/bin/env node
!function(e){"use strict";var i=require("path"),t=require("fs"),n=t.existsSync||i.existsSync,o=require("formidable"),s=require("node-static"),a=require("imagemagick"),r={tmpDir:__dirname+"/tmp",publicDir:__dirname+"/public",uploadDir:__dirname+"/public/files",uploadUrl:"/files/",maxPostSize:11e9,minFileSize:1,maxFileSize:1e10,acceptFileTypes:/.+/i,inlineFileTypes:/\.(gif|jpe?g|png)$/i,imageTypes:/\.(gif|jpe?g|png)$/i,imageVersions:{thumbnail:{width:80,height:80}},accessControl:{allowOrigin:"*",allowMethods:"OPTIONS, HEAD, GET, POST, PUT, DELETE",allowHeaders:"Content-Type, Content-Range, Content-Disposition"},nodeStatic:{cache:3600}},l=function(e){return unescape(encodeURIComponent(e))},c=new s.Server(r.publicDir,r.nodeStatic),p=/(?:(?: \(([\d]+)\))?(\.[^.]+))?$/,d=function(e,i,t){return" ("+((parseInt(i,10)||0)+1)+")"+(t||"")},u=function(e){this.name=e.name,this.size=e.size,this.type=e.type,this.deleteType="DELETE"},h=function(e,i,t){this.req=e,this.res=i,this.callback=t},m=function(e,i){i.setHeader("Access-Control-Allow-Origin",r.accessControl.allowOrigin),i.setHeader("Access-Control-Allow-Methods",r.accessControl.allowMethods),i.setHeader("Access-Control-Allow-Headers",r.accessControl.allowHeaders);var t=function(t,n){n?(i.writeHead(302,{Location:n.replace(/%s/,encodeURIComponent(JSON.stringify(t)))}),i.end()):(i.writeHead(200,{"Content-Type":-1!==e.headers.accept.indexOf("application/json")?"application/json":"text/plain"}),i.end(JSON.stringify(t)))},n=function(){i.setHeader("Pragma","no-cache"),i.setHeader("Cache-Control","no-store, no-cache, must-revalidate"),i.setHeader("Content-Disposition",'inline; filename="files.json"')},o=new h(e,i,t);switch(e.method){case"OPTIONS":i.end();break;case"HEAD":case"GET":"/"===e.url?(n(),"GET"===e.method?o.get():i.end()):c.serve(e,i);break;case"POST":n(),o.post();break;case"DELETE":o.destroy();break;default:i.statusCode=405,i.end()}};c.respond=function(e,t,n,o,a,c,p,d){n["X-Content-Type-Options"]="nosniff",r.inlineFileTypes.test(o[0])||(n["Content-Type"]="application/octet-stream",n["Content-Disposition"]='attachment; filename="'+l(i.basename(o[0]))+'"'),s.Server.prototype.respond.call(this,e,t,n,o,a,c,p,d)},u.prototype.validate=function(){return r.minFileSize&&r.minFileSize>this.size?this.error="File is too small":r.maxFileSize&&r.maxFileSize<this.size?this.error="File is too big":r.acceptFileTypes.test(this.name)||(this.error="Filetype not allowed"),!this.error},u.prototype.safeName=function(){for(this.name=i.basename(this.name).replace(/^\.+/,"");n(r.uploadDir+"/"+this.name);)this.name=this.name.replace(p,d)},u.prototype.initUrls=function(e){if(!this.error){var i=this,t=(r.ssl?"https:":"http:")+"//"+e.headers.host+r.uploadUrl;this.url=this.deleteUrl=t+encodeURIComponent(this.name),Object.keys(r.imageVersions).forEach(function(e){n(r.uploadDir+"/"+e+"/"+i.name)&&(i[e+"Url"]=t+e+"/"+encodeURIComponent(i.name))})}},h.prototype.get=function(){var e=this,i=[];t.readdir(r.uploadDir,function(n,o){o.forEach(function(n){var o,s=t.statSync(r.uploadDir+"/"+n);s.isFile()&&"."!==n[0]&&(o=new u({name:n,size:s.size}),o.initUrls(e.req),i.push(o))}),e.callback({files:i})})},h.prototype.post=function(){var e,n=this,s=new o.IncomingForm,l=[],c=[],p={},d=1,h=function(){d-=1,d||(c.forEach(function(e){e.initUrls(n.req)}),n.callback({files:c},e))};s.uploadDir=r.tmpDir,s.on("fileBegin",function(e,t){l.push(t.path);var o=new u(t,n.req,!0);o.safeName(),p[i.basename(t.path)]=o,c.push(o)}).on("field",function(i,t){"redirect"===i&&(e=t)}).on("file",function(e,n){var o=p[i.basename(n.path)];return o.size=n.size,o.validate()?(t.renameSync(n.path,r.uploadDir+"/"+o.name),void(r.imageTypes.test(o.name)&&Object.keys(r.imageVersions).forEach(function(e){d+=1;var i=r.imageVersions[e];a.resize({width:i.width,height:i.height,srcPath:r.uploadDir+"/"+o.name,dstPath:r.uploadDir+"/"+e+"/"+o.name},h)}))):void t.unlink(n.path)}).on("aborted",function(){l.forEach(function(e){t.unlink(e)})}).on("error",function(e){console.log(e)}).on("progress",function(e){e>r.maxPostSize&&n.req.connection.destroy()}).on("end",h).parse(n.req)},h.prototype.destroy=function(){var e,n=this;return n.req.url.slice(0,r.uploadUrl.length)===r.uploadUrl&&(e=i.basename(decodeURIComponent(n.req.url)),"."!==e[0])?void t.unlink(r.uploadDir+"/"+e,function(i){Object.keys(r.imageVersions).forEach(function(i){t.unlink(r.uploadDir+"/"+i+"/"+e)}),n.callback({success:!i})}):void n.callback({success:!1})},r.ssl?require("https").createServer(r.ssl,m).listen(e):require("http").createServer(m).listen(e)}(8888);